{% extends "base.html.twig" %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('assets/vendor/nouislider/distribute/nouislider.css') }}">

    <style>
        #recherche{
            margin-top: 50px;
        }
        .billet{
            /*border : 1px solid lightgrey;*/
            margin: 10px;
            padding: 15px;
            border-radius: 3px;
        }

        #slider{
            margin-bottom: 50px;
        }
    </style>

{% endblock %}

{% block body %}

    <section class="container-fluid">

        <div class="row" id="recherche">

            <div class="col s5">

                <div class="row">
                    <form class="col s12">

                        <div class="input-field col s12">
                            <select multiple id="sources">
                                <option value="" disabled selected>Select a source (2 max)</option>
                                {% for item in sources %}
                                    <option value="{{ item.title|e('html') }}">{{ item.title|e('html') }}</option>
                                {% endfor %}
                            </select>
                            <label>Sources (muliple choice, max 2)</label>
                        </div>

                        <div class="input-field col s12">
                            <select id="performance">
                                <option value="" disabled selected>Select a performance</option>
                                {% for item in performances %}
                                    <option value="{{ item.title|e('html') }}">{{ item.title|e('html') }}</option>
                                {% endfor %}
                            </select>
                            <label>Performances (1 choice)</label>
                        </div>
                    </form>
                </div>

                <div class="row col s12">
                    <div  id="slider"></div>
                </div>

                <article class="s12 col card">
                    <h2>Some stats</h2>

                    <div class="songsSelection"></div>
                    <div class="choreographersSelection"></div>
                    <div class="performersSelection"></div>
                    <div class="filmsSelection"></div>

                </article>
            </div>

            <div class="col s7">
                <div class="s12 card" id="resultat"></div>
            </div>

        </div>

    </section>


{% endblock %}

{% block javascripts %}

    {{ parent() }}
    <script src="{{ asset('assets/vendor/wnumb/wNumb.js') }}"></script>
    <script src="{{ asset('assets/vendor/nouislider/distribute/nouislider.js') }}"></script>
    <script>

        var data = [
            {% for number in numbers  %}
            {
                'id' : {{ number.numberId }},
                'title' : '{{ number.title() }}',
                'performance' : '{{ number.performanceThesaurus }}',
                'sources' : [ {% for source in number.sourceThesaurus %}'{{source.title}}'{% if loop.last %}{% else %},{% endif %}{% endfor %} ],
                'filmId' : '{{ number.film.filmId }}',
                'film' : '{{ number.film.title }}',
                'released' : {{ number.film.released }},
                'choreographers' : [ {% for person in number.choregraphers %}'{{person.name|json_encode()}}'{% if loop.last %}{% else %},{% endif %}{% endfor %} ],
                'performers' : [ {% for person in number.performers %}'{{person.name|json_encode()}}'{% if loop.last %}{% else %},{% endif %}{% endfor %} ],
                'songs' : [{% for item in number.song %} { 'songId' : {{item.songId}}, 'songTitle' : '{{item.title}}' }{% if loop.last %}{% else %},{% endif %}{% endfor %}]
            }
            {% if loop.last %}{% else %},{% endif %}
            {% endfor %}

        ];


        var _performance = '';
        var sources = '';
        var _source1 = '';
        var _source2 = '';
        var _compteur = '';
        var listSongs = [];
        var allSongs = [];
        var song = {'id' : '', 'title'  : '', 'nb' : 0};
        var titleSongs= '';

        var _min = 1850;
        var _max = 2000;

        //////////////////////////////////////////////////////////////////////////////

        String.prototype.like = function(search) {
            // Remove special chars
            search = search.replace(new RegExp("([\\.\\\\\\+\\*\\?\\[\\^\\]\\$\\(\\)\\{\\}\\=\\!\\<\\>\\|\\:\\-])", "g"), "\\$1");
            // Check matches
            return RegExp('^.*' + search + '$', 'i').test(this);
        };


        //////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////

        function filter(_performance, _source1, _source2, _min, _max){

            $("#resultat").html('');
            var billets = '';
            allSongs = [];
            _compteur = 0;
            listSongs = '';

            var source1Finale;
            var source2Finale;

            if (_performance == null) {
                _performance = "";
            }
            if (typeof(_source1) == "undefined") {
                _source1 = "";
            }
            if (typeof(_source2) == "undefined") {
                _source2 = "";
            }


            <!-- Sélection des items via la fonction grep -->

            $.grep( data, function( n, i ) {

                if (typeof(n.sources[0]) == "undefined") {
                    n.sources[0] = "";
                }
                if (typeof(n.sources[1]) == "undefined") {
                    n.sources[1] = "";
                }
                if (typeof(n.performance) == "undefined") {
                    n.performance = "";
                }

//                console.log(typeof(_min));

//                if (n.performance === _performance && n.sources[0] == _source1 && n.sources[1] == _source2 && n.released > _min && n.released < _max ){

                if (n.sources[0].like(_source1) && n.sources[1].like(_source2) && n.performance.like(_performance) && n.released > _min && n.released < _max) {

                    if (n.sources[0] == "") {
                        source1Finale = "";
                    }
                    else {
                        source1Finale = n.sources[0];
                    }
                    if (n.sources[1] == "") {
                        source2Finale = "";
                    } else {
                        source2Finale = "; " + n.sources[1];
                    }

                    listSongs = '';

                    for(i=0; i < n.songs.length; i++){

                        listSongs+= "<a href='/song/id/"+n.songs[i].songId+"'>"+n.songs[i].songTitle+"</a>";


                        song = {};

                        song.id = n.songs[i].songId;
                        song.title = n.songs[i].songTitle;
                        song.nb = 1;

                        allSongs.push(song);

                        if(i == (n.songs.length)-1){
                            listSongs += " ";
                        }
                        else{
                            listSongs += " , ";
                        }
                    }


                    if(_compteur < 20){
                    billets += "<div class='billet card'><div><a href='/number/"+n.id+"'><h2>"+n.title+"</h2></a><a href='/film/id/"+n.filmId+" '><h3>"+n.film+" ("+n.released+")"+"</h3></a><p> Performance type : "+n.performance+"</p><p>Sources : "+n.sources[0]+", "+n.sources[1]+"</p></div><div><p>Choreographers : "+n.choreographers+"</p></div><div><p>Performers : "+n.performers+"</p></div><div><p>Song(s) : "+listSongs+"</p></div></div>";
                    }
                    _compteur ++;

                    //ajouter les résultats dans un tableau

                    infos = "<div>Number of results : "+_compteur+" (only the first 20 numbers are displayed)</div>";
                    $("#resultat").html(infos+billets);


                }

            });

            //Display all songs

            titleSongs = '';
            textForSongs ='';


            for(i = 0; i < allSongs.length; i++){


                if (i != allSongs.length - 1) {
                    titleSongs += "<a href='/song/id/"+allSongs[i].id+"'>"+allSongs[i].title+"</a>,";
                } else {
                    titleSongs += "<a href='/song/id/"+allSongs[i].id+"'>"+allSongs[i].title+"</a>.";
                }
            }

            nbSongsInSelection = allSongs.length;
            textForSongs = "<div><h3>"+nbSongsInSelection+" songs in the selection</h3><p>"+titleSongs+"</p></div>";
            $(".songsSelection").html(textForSongs);

        }//end of filter()

        //////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////

        $("select").change(function(){

            sources = $("#sources").val();
            _performance = $('#performance').val();

            _source1 = sources[0];
            _source2 = sources [1];


            if ($('#sources').val().length >2 ) {
                alert('You can only choose 2!');
            } else {
                filter(_performance, _source1, _source2, _min, _max);
            }

        })


        //////////////////////////////////////////////////////////////////////////////
        //Slider
        //////////////////////////////////////////////////////////////////////////////

        var slider = document.getElementById('slider');

        noUiSlider.create(slider, {
            start: [1880, 1980],
            connect: true,
            range: {
                'min': _min,
                'max': _max
            },
            format: wNumb({
                decimals: 0
            }),
            tooltips: true,
            step: 1

        });

        slider_values = [];
        var min_slider ='';
        var max_slider ='';

        console.log(max_slider);

        slider.noUiSlider.on('end', function(){
            slider_values = slider.noUiSlider.get();
            min_slider = slider_values[0];
            max_slider = slider_values[1];
            console.log(max_slider);
            filter(_performance, _source1, _source2, min_slider, max_slider);
        });

        //////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////

        $(document).ready(function() {
            Materialize.updateTextFields();
            $('select').material_select();

        });






    </script>

{% endblock %}


